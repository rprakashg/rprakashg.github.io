{"componentChunkName":"component---src-templates-blog-post-js","path":"/haproxy-ingress-with-argocd/","result":{"data":{"site":{"siteMetadata":{"url":"https://rprakashg.github.io","title":"rprakashg.github.io"}},"markdownRemark":{"html":"<p>When you use HAProxy Ingress with ArgoCD on Kubernetes you are going to run into this error 'ERR_TOO_MANY_REDIRECTS' when you browse to the ArgoCD server URL. I lost of few hours trying to figure out what the cause is and wanted to write this up with the hope that it saves some one else time later and also a note for myself so I don't forget exactly what I did to solve the issue.</p>\n<p>I installed ArgoCD server on my EKS cluster following the instructions in the ArgoCD docs using the command below</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kubectcl create namespace gitops\nkubectl apply -n gitops -f https://raw.githubusercontent.com/argoproj/argo-cd/master/manifests/install.yaml</code></pre></div>\n<p>After that I created an Ingress Resource by running the command below</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">cat &lt;&lt;EOF | kubectl apply -f -\napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: argocd\n  namespace: gitops\nspec:\n  ingressClassName: haproxy\n  rules:\n  - host: gitops.sandbox2841.opentlc.com\n    http:\n      paths:\n      - backend:\n          service:\n            name: argocd-server\n            port:\n              name: https\n        path: /\n        pathType: Prefix\n  tls:\n  - hosts:\n    - gitops.sandbox2841.opentlc.com\nEOF</code></pre></div>\n<p>Browse to <code class=\"language-text\">https://gitops.sandbox2841.opentlc.com</code> and started noticing 'ERR_TOO_MANY_REDIRECTS'. reason why this was happening is because HAProxy by default terminates SSL and forwards HTTP to backend service and ArgoCD server when it sees an HTTP traffic it automatically redirects to HTTPS. This results in an infinite loop and eventually HAProxy gives up and you see that error in browser.\nSo to fix this problem I simply had to add an annotation <code class=\"language-text\">ingress.kubernetes.io/ssl-passthrough: \"true\"</code> to the ingress resource so HAProxy instead of terminating HTTPS traffic at the proxy will do an SNI passthrough.</p>\n<p>Updated Ingress resource as shown below</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: argocd\n  namespace: gitops\n  annotations:\n    ingress.kubernetes.io/ssl-passthrough: \"true\"\nspec:\n  ingressClassName: haproxy\n  rules:\n  - host: gitops.sandbox2841.opentlc.com\n    http:\n      paths:\n      - backend:\n          service:\n            name: argocd-server\n            port:\n              name: https\n        path: /\n        pathType: Prefix\n  tls:\n  - hosts:\n    - gitops.sandbox2841.opentlc.com\nEOF</code></pre></div>\n<p>Grab the admin password from kubernetes secret by running command below</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kubectl get secrets argocd-initial-admin-secret -n gitops -o jsonpath=\"{.data.password}\" | base64 -d | pbcopy</code></pre></div>\n<p>Browse to <code class=\"language-text\">https://gitops.sandbox2841.opentlc.com</code> enter admin for username and paste the password obtained from previous step and you will be logged into ArgoCD server successfully as shown in screen capture below</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9ea613f81a97d2d066809a1501b42380/12e1b/argocd.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABhElEQVR42pWQu0oDURCGt40gWlmKCqKNgkSENIIvIHa2lj6ZLyAoKSw06qrEJOayJCa7m83er7nauMn+zjkJooVCio85Z+acj5kRXD+Cb/uwTR+GHcJ0Quh2BMvrw49GHMMK4dDdDUdw/D48FoMBTJdyFG1WC4b0pgvh5OwcmeNTiPkioh4V/ICKERUDxHGMeDym+IkxxfFkgiRJgBkJ3enwnUuSCYTV9CFS6zu4uMwiX2si91rBQ6HK6bgB4cMMurDDHsyIuu6PEPSHxAjhgM69ISec5YW1gyMsbu4he/8Mb/CBtkMSL+TIlsdpme4U4zeNjo1iQ0WxrqKuWTwnrOxkuPDqVoRJXTR1GzJ9Zigk+wuV9i6pBipNDdVWBzXF4DlhaSuN1MYuru9EWDRSy3D+FXEZwSZhXVdIxmjqDjRakbC8vY+FOYSsc0nVaVQZ5XeVutOmUdZQaijzCdlIdc0kSZskCt5IcCMWkM290B5lSIo+f4c/5Wzkp3IdjyWJ/2Nr+AJ7vXGtXdpr+wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"argocd\"\n        title=\"\"\n        src=\"/static/9ea613f81a97d2d066809a1501b42380/5a190/argocd.png\"\n        srcset=\"/static/9ea613f81a97d2d066809a1501b42380/772e8/argocd.png 200w,\n/static/9ea613f81a97d2d066809a1501b42380/e17e5/argocd.png 400w,\n/static/9ea613f81a97d2d066809a1501b42380/5a190/argocd.png 800w,\n/static/9ea613f81a97d2d066809a1501b42380/c1b63/argocd.png 1200w,\n/static/9ea613f81a97d2d066809a1501b42380/29007/argocd.png 1600w,\n/static/9ea613f81a97d2d066809a1501b42380/12e1b/argocd.png 1607w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Hope this helps,</p>\n<p>Thanks,\nRam</p>","frontmatter":{"title":"Fixing error 'ERR_TOO_MANY_REDIRECTS' when using HAProxy with ArgoCD","date":"March 14, 2024","tags":["gitops","argocd","Kubernetes"],"author":"Ram Gopinathan"}}},"pageContext":{"slug":"/haproxy-ingress-with-argocd/"}},"staticQueryHashes":["1611934721","2366241629"],"slicesMap":{}}