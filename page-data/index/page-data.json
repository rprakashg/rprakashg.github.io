{"componentChunkName":"component---src-pages-index-js","path":"/","result":{"data":{"site":{"siteMetadata":{"title":"rprakashg.github.io","author":"RAM GOPINATHAN"}},"allMarkdownRemark":{"totalCount":14,"edges":[{"node":{"excerpt":"As many of you may already know Red Hat Developer hub which is based on backstage project created by Spotify hit GA. If you are not familiar with RedHat Developer hub or backstage check out thisâ€¦","html":"<p>As many of you may already know Red Hat Developer hub which is based on backstage project created by Spotify hit GA. If you are not familiar with RedHat Developer hub or backstage check out this <a href=\"https://developers.redhat.com/rhdh\">article</a>. You can deploy and run developer hub on all x-K8s (AKS, EKS, GKE). In this post I will cover how to install and configure RedHat developer hub on Amazon Elastic Kubernetes Service (EKS). If you are using AKS or GKE I would think these steps would work just fine although I haven't tested in AKS or GKE. Everything I'm covering in this post can be found in this Github <a href=\"https://github.com/rprakashg-redhat/rhdh-on-eks\">repo</a>.</p>\n<p>Lets get right into it.</p>\n<p>As in many previous posts where I used EKS I'm going to use terraform to provision EKS cluster. You can find the terraform scripts <a href=\"https://github.com/rprakashg-redhat/rhdh-on-eks/tree/main/deploy/infra\">here</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">terraform init\nterraform plan\nterraform apply --var \"name=toolscluster\"</code></pre></div>\n<p>Once the cluster is provisioned we need to install an Ingress controller. There are variety of options out there but for the purposes of this post I decided to use HAProxy. HAProxy also provides an EKS addon that makes it super easy to install on to cluster but I'm going to use helm to install HAProxy controller on the cluster.</p>\n<p>You can download the kubeconfig file to authenticate with the cluster by running command below.</p>\n<p>note: <em>Be sure to make sure region value matches to one you specified when cluster was created.</em></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">aws eks update-kubeconfig --region us-west-2 --name \"toolscluster\"</code></pre></div>\n<p>First we are going to add the HAProxy helm chart repo by running command below</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">helm repo add haproxytech https://haproxytech.github.io/helm-charts</code></pre></div>\n<p>Update helm charts by running <code class=\"language-text\">helm repo update</code> and install the HAProxy ingress controller by running command below</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">helm install haproxy-kubernetes-ingress haproxytech/kubernetes-ingress \\\n  --create-namespace \\\n  --namespace haproxy-controller \\\n  --set controller.service.type=LoadBalancer</code></pre></div>\n<p>Check if the ALB is provisioned successfully on AWS by running <em><code class=\"language-text\">kubectl describe service haproxy-ingress -n haproxy-controller</code></em>. You should see full DNS name of your ALB provisioned in Amazon for public IP. If it shows pending that means some issue which you should see in the status section.</p>\n<p>Next thing we are going to do is to update the route 53 hosted zone to create an A record so we can have a friendly URL like so <em><code class=\"language-text\">devhub.sandbox2841.opentlc.com</code></em>. Basically this is going to act as an alias for routing traffic to the ALB provisioned by HAProxy Ingress controller. See screenshopt below</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/006e0d3131e87b186c82c19ea6463e89/18c33/r53updates.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABGklEQVR42pWS+06DMBjFef/H8gl08ZKYsDllUjagtPTG9XjaTeMfLmrJL18bei4JZDebHHePz9g8POF2c498t4c4HlFWglR/5r0UeCsOyE6NRFWVUErBBw8XAsIw/BtPnXMO2WtZ4SAqnJoWTdui5tR9DxXR+sznmXQ8/wgLxZmVNKtbeRH3NDPQ1id8uCR7n4j7gW0S45jmyDlOEyzbpYbGGEjZwViLQIPvDMMITyPLd1FgjIWzZ2EiBnEqpXk/JLJpmilwKem3ta7rV6OVz7IsyXC7e0mFolcWmHLkV22bBss8R9VVVhrE+54mcc00j/uiKJJ+ZlAmhUCx2+JAOhq7roOV8irqxHBq4j1d15D8ZYo8h9jv4bXCB3NJZmPOVaChAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"r53update\"\n        title=\"\"\n        src=\"/static/006e0d3131e87b186c82c19ea6463e89/5a190/r53updates.png\"\n        srcset=\"/static/006e0d3131e87b186c82c19ea6463e89/772e8/r53updates.png 200w,\n/static/006e0d3131e87b186c82c19ea6463e89/e17e5/r53updates.png 400w,\n/static/006e0d3131e87b186c82c19ea6463e89/5a190/r53updates.png 800w,\n/static/006e0d3131e87b186c82c19ea6463e89/c1b63/r53updates.png 1200w,\n/static/006e0d3131e87b186c82c19ea6463e89/29007/r53updates.png 1600w,\n/static/006e0d3131e87b186c82c19ea6463e89/18c33/r53updates.png 1775w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Create a namespace <code class=\"language-text\">tools</code> on the cluster where we will install developer hub components by running <em><code class=\"language-text\">kubectl create namespace tools</code></em></p>\n<p>Next thing we are going to do is download redhat pull secret file from <em>cloud.redhat.com</em> and save it locally as pull-secret.txt file then create a kubernetes secret as shown below</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kubectl create secret generic rhdh-pull-secret \\\n  -n tools \\\n  --from-file=.dockerconfigjson=pull-secret.txt \\\n  --type=kubernetes.io/dockerconfigjson</code></pre></div>\n<p>Path the default service account to be able to pull images from redhat registries using the kubernetes secret we created earlier by running command below</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kubectl patch sa default -n tools -p '{\"imagePullSecrets\": [{\"name\": \"rhdh-pull-secret\"}]}'</code></pre></div>\n<p>Next thing we are going to do is create a kubernetes secret to store all sensitive configurations we want to use in the app config file for backstage. See below</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kubectl create secret generic rhdh-secrets \\\n  -n tools \\\n  --from-literal=AUTH_OKTA_CLIENT_ID=${AUTH_OKTA_CLIENT_ID} \\\n--from-literal=AUTH_OKTA_CLIENT_SECRET=${AUTH_OKTA_CLIENT_SECRET} \\\n--from-literal=AUTH_OKTA_DOMAIN=${AUTH_OKTA_DOMAIN} \\\n--from-literal=AUTH_OKTA_ADDITIONAL_SCOPES=${AUTH_OKTA_ADDITIONAL_SCOPES} \\\n--from-literal=GITLAB_TOKEN=${GITLAB_TOKEN} \\\n--from-literal=GITLAB_APP_APP_ID=${GITLAB_APP_APP_ID} \\\n--from-literal=GITLAB_APP_CLIENT_ID=${GITLAB_APP_CLIENT_ID} \\\n--from-literal=GITLAB_APP_CLIENT_SECRET=${GITLAB_APP_CLIENT_SECRET} \\\n--from-literal=GITHUB_APP_APP_ID=${GITHUB_APP_APP_ID} \\\n--from-literal=GITHUB_APP_CLIENT_ID=${GITHUB_APP_CLIENT_ID} \\\n--from-literal=GITHUB_APP_CLIENT_SECRET=${GITHUB_APP_CLIENT_SECRET} \\\n--from-literal=GITHUB_ORG=${GITHUB_ORG} \\\n--from-literal=GITHUB_APP_WEBHOOK_URL=${GITHUB_APP_WEBHOOK_URL} \\\n--from-literal=GITHUB_APP_WEBHOOK_SECRET=${GITHUB_APP_WEBHOOK_SECRET} \\\n--from-literal=GITHUB_TOKEN=${GITHUB_TOKEN} \\\n--from-literal=BACKSTAGE_AWS_ACCOUNT_ID=${BACKSTAGE_AWS_ACCOUNT_ID} \\\n--from-literal=AWS_ACCESS_KEY_ID=${BACKSTAGE_AWS_ACCESS_KEY_ID} \\\n--from-literal=AWS_SECRET_ACCESS_KEY=${BACKSTAGE_AWS_SECRET_ACCESS_KEY} \\\n--from-literal=TECHDOCS_AWSS3_BUCKET_NAME=${TECHDOCS_AWSS3_BUCKET_NAME} \\\n--from-literal=TECHDOCS_AWSS3_BUCKET_URL=${TECHDOCS_AWSS3_BUCKET_URL} \\\n--from-literal=AWS_REGION=${AWS_REGION} \\\n--from-literal=EKS_CLUSTER_URL=${EKS_CLUSTER_URL} \\\n--from-literal=EKS_CLUSTER_NAME=${EKS_CLUSTER_NAME} \\\n--from-literal=BACKSTAGE_ROLE_ARN_TO_ASSUME=${BACKSTAGE_ROLE_ARN_TO_ASSUME} \\\n--from-literal=AWS_EXTERNAL_ID=${AWS_EXTERNAL_ID} \\\n--from-literal=EKS_SA_TOKEN=${EKS_SA_TOKEN} \\\n--from-literal=ARGOCD_USER_ID=${ARGOCD_USER_ID} \\\n--from-literal=ARGOCD_USER_PWD=${ARGOCD_USER_PWD}</code></pre></div>\n<p>I was testing OKTA, GITHUB, GITLAB mine looks pretty large. Approach I took was to keep a local env file that contains all the values specific to my environment\nand I would run command <em><code class=\"language-text\">export $(cat local.env | xargs)</code></em>  before creating the secret.</p>\n<p>Originally for Auth I used OKTA and eventually landed on using GitHub. Steps for creating app in github is pretty well documented so I'm not going to cover that. Once you create the app in github you will endup having to create a private key as well. Download the private key in to your local machine and create another kubernetes secret to store the private key for your app as you will need to specify that in the app config for backstage</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kubectl create secret generic -n tools gh-app-key \\\n--from-file=GITHUB_APP_PRIVATE_KEY=\"/Users/rgopinat/keys/demo-rhdh.2024-02-26.private-key.pem\"</code></pre></div>\n<p>For Kubernetes plugin I downloaded the EKS CA Certificate from aws console and saved locally to create another secret to store that EKC CA data as shown below</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kubectl create secret generic -n tools eks-ca-data \\\n--from-file=EKS_CA_DATA=eks-ca.txt</code></pre></div>\n<p>Next I do have to tell backstage about all these secrets I've created so backstage can load them as environment variables and we can do that by updating a section in values file as shown below</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"> extraEnvVarsSecrets:\n    - rhdh-secrets\n    - gh-app-key\n    - eks-ca-data</code></pre></div>\n<p>Next thing we are going to do is to go ahead and create the app config configmap. You can see a copy of mine <a href=\"https://github.com/rprakashg-redhat/rhdh-on-eks/blob/main/deploy/rhdh/developer-hub-appconfig.yaml\">here</a></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kubectl apply -f deploy/rhdh/developer-hub-appconfig.yaml</code></pre></div>\n<p>It is worth talking a little bit about this snippet of yaml below in the app config. Basically this is going to tell backstage to automatically ingest entities from github and the two static locations you see are one for golden path templates and the other one is for ingesting all APIs from repo where I'm storing all API specifications</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">catalog:\n    import:\n    entityFileName: catalog-info.yaml\n    rules:\n    - allow: [Component, System, API, Resource, Location, Domain, Template]\n    locations:\n    - type: url\n        target: https://github.com/rprakashg-redhat/rhdh-templates/blob/main/all-templates.yaml\n    - type: url\n        target: https://github.com/rprakashg-redhat/apis/blob/main/all-apis.yaml</code></pre></div>\n<p>At this point we are ready to install redhat developer hub. We provide a Helm chart to do just that. We will add the helm chart repo with this command <em><code class=\"language-text\">helm repo add openshift-helm-charts https://charts.openshift.io/</code></em>. Next we need to download the values yaml so we can review and customize them to fit to this EKS installation.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">helm show values openshift-helm-charts/redhat-developer-hub > values.yaml</code></pre></div>\n<p>Customize the values yaml. You can see the version I used for my installation <a href=\"https://github.com/rprakashg-redhat/rhdh-on-eks/blob/main/deploy/rhdh/values.yaml\">here</a>.\nFew other customizations to values file that are worth calling out are below</p>\n<ol>\n<li>Specified the custom hostname <code class=\"language-text\">devhub.sandbox2841.opentlc.com</code> under section global of values yaml</li>\n<li>Since I was using HAProxy ingress under upstream section I had to enable ingress and specify className as shown in the snippet below</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ingress:\n    enabled: true\n    host: \"{{ .Values.global.host }}\"\n    className: haproxy</code></pre></div>\n<ol start=\"3\">\n<li>Tell developer hub about the app config by updating the extraAppConfig section under upstream->backstage section in values file as shown in snippet below</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">extraAppConfig:\n- configMapRef: \"developer-hub-appconfig\"\n  filename: \"developer-hub-appconfig.yaml\"</code></pre></div>\n<ol start=\"4\">\n<li>Update podSecurityContext section under upstream->backstage and include below config</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">podSecurityContext:\n    runAsUser: 1001\n    runAsGroup: 1001\n    fsGroup: 1001</code></pre></div>\n<ol start=\"5\">\n<li>Update podSecurityContext section under upstream->postgresql->primary section in values file as shown in snippet below</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">podSecurityContext:\n    enabled: true\n    fsGroup: 26\n    runAsUser: 26</code></pre></div>\n<p>and set volume permissions to enabled as shown in snippet below</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">volumePermissions:\n    enabled: true</code></pre></div>\n<ol start=\"6\">\n<li>Lastly I had to set route enabled to false since I'm not running developer hub on Openshift.</li>\n</ol>\n<p>At this point we can go ahead and install redhat developer hub by running command <em><code class=\"language-text\">helm upgrade --namespace tools -i developer-hub -f values.yaml openshift-helm-charts/redhat-developer-hub</code></em></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">helm upgrade --namespace tools -i developer-hub -f values.yaml openshift-helm-charts/redhat-developer-hub</code></pre></div>\n<p>Browse to <em><code class=\"language-text\">https://devhub.sandbox2841.opentlc.com</code></em> from a browser and login and you will be in home page of developer hub as shown in screen capture below</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/28b17bc865fbf5cf1eddb74c31dd8d3f/c2d13/devhubhome.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 34%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABFUlEQVR42oWQyU7DMBCG/UpIXErpQuGZWKQ0cKRcCqqKql7CI3FFLEpFgKaBRNmc2Fl+xgYkhNJi6dN4xv5/z5i1trZxa57BPr/AnTHEvXmKx6GJh8MjPB2fwDYMLCh/GY3wNh7DvbyCN5ngfT6Hb1kIrBuEiusp4tkMrNMf4HXpQpYlZFVBUBQUZV03kgqBKMv0XUVWSEhAo3SsPziA4ziQUqCmQk0iHRuo6LEoDOEHAXiaIuMcJdWq77OiKMDanR4W9rNOyAqblhLmea7hZKbIqNufmoLt7HaxWnlaoLvbwG/DdbBWuwvPXSJOOdJc/tuhoD9cZ6bOWG9vH77/oUcW8stQ/Yuk/V+UIEkSPWqTWRTH+ATO9QPErE/ovAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"devhubhome\"\n        title=\"\"\n        src=\"/static/28b17bc865fbf5cf1eddb74c31dd8d3f/5a190/devhubhome.png\"\n        srcset=\"/static/28b17bc865fbf5cf1eddb74c31dd8d3f/772e8/devhubhome.png 200w,\n/static/28b17bc865fbf5cf1eddb74c31dd8d3f/e17e5/devhubhome.png 400w,\n/static/28b17bc865fbf5cf1eddb74c31dd8d3f/5a190/devhubhome.png 800w,\n/static/28b17bc865fbf5cf1eddb74c31dd8d3f/c1b63/devhubhome.png 1200w,\n/static/28b17bc865fbf5cf1eddb74c31dd8d3f/29007/devhubhome.png 1600w,\n/static/28b17bc865fbf5cf1eddb74c31dd8d3f/c2d13/devhubhome.png 2560w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Navigating to APIs you can see that petstore api was ingested into catalog automatically from the repo. Currently repo has only one API spec but as we add more API specs they would be automatically ingested into the catalog which is super cool.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b38495c951fb65d0bdb74d3f88c140f0/c2d13/apis.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABdklEQVR42p2Qy07bUBRF/VNIlQptESp/AA0tj34AUyJAoAqplfgixp12yis8bNlJnIcdnKTx9bUdJ1mca2AAUiYMts5jn7vvPsfy601adoP7Kw+71sC5kfzCwZXYtNslGvdtfLtDyw3w3ZCWF+LXHwQR3WZEz39Cx+tirSx84F/lO5ffKpxXNqjt/OT6xya1tXXupLY3t3C2d6jv7uLv7dGuVukeHBCenNA/PSX4/Qf38BdBdR91fIS1uPSZjuuSDf+jej1G3QAd9ckGQ9K+iQPhhuRKkcfxE0Yx2WjETCfUxdXZ3wtubpulhrW8skonCCimU3SWEUkzLwqmQD6ZlLGYzlBpxmQ2o5BeonU5W86Mc7JUk0odJ4k4/LSM53kocTAUJ0qamZBpmr6CEXnJtRF8rk1UiSaRdyYXwS84jsNA1uvJyvpZ8L2wPsoNwzBkPB6Xv5hfDZHn+VzMEzOc3PArURRRyN2MZUOUa8gJ5uFl7q1YrBSPxtpBSg4C1TgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"apis\"\n        title=\"\"\n        src=\"/static/b38495c951fb65d0bdb74d3f88c140f0/5a190/apis.png\"\n        srcset=\"/static/b38495c951fb65d0bdb74d3f88c140f0/772e8/apis.png 200w,\n/static/b38495c951fb65d0bdb74d3f88c140f0/e17e5/apis.png 400w,\n/static/b38495c951fb65d0bdb74d3f88c140f0/5a190/apis.png 800w,\n/static/b38495c951fb65d0bdb74d3f88c140f0/c1b63/apis.png 1200w,\n/static/b38495c951fb65d0bdb74d3f88c140f0/29007/apis.png 1600w,\n/static/b38495c951fb65d0bdb74d3f88c140f0/c2d13/apis.png 2560w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>To create new components we can click on create and you'll see all golden path templates ingested into the catalog as shown in screen capture below. I currently have just two.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6ae8ea059068618f507cd176d129edee/c2d13/templates.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABs0lEQVR42m2Qy27TQBhG/VBIbBqgquANQAWVbrhIoG4bUbW0UpFA6hq2fYAuoEtWSGxgC7Q4ECdxLnYutusk+Jo49uEfR0ICOtLRN/+MdOazNavTo2/aNOuCIfzoYnxr0NI79GTuNvp0jD5WY4BtjrAE23Sw2h52x2Nk+TjWBa4wbA/R1q5c5fP6Pc4fPER/8pSfjx5T27hP7fYd6ut3aci+ublJd2sLe3ubQbXKcGcH9/AF7stXtPcPae8eMKo+I9p/jlapXKf+5SvDVoux3WcyGgkOkecROpIXPtF4TDydEqscT8o5nU7whi4fPum8/3jGd71N7I/RVtdu0bEswijiV7ag+/Ydxt4e3vExwckJ1us39I6O8CSD01PSJCHNMtL5nJlkUeQU5GT5ojzTVq6tUjcMXGnjSCun0cQ9O2dimiSDAa6uCzXiXo+565Km6V8k8kAsqFRzKbSkoRoiaRkmKYuCcuVCPJuRSJMsz8mL4j/hv2grlRv4vs9c6sZxTCKofSaSROTqExdKOM+kScpMHlBcJlPn8g9vlsKlYFlbicMw/EMQBGVG0XJW95fJgjDkN0lvONQfEOenAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"templates\"\n        title=\"\"\n        src=\"/static/6ae8ea059068618f507cd176d129edee/5a190/templates.png\"\n        srcset=\"/static/6ae8ea059068618f507cd176d129edee/772e8/templates.png 200w,\n/static/6ae8ea059068618f507cd176d129edee/e17e5/templates.png 400w,\n/static/6ae8ea059068618f507cd176d129edee/5a190/templates.png 800w,\n/static/6ae8ea059068618f507cd176d129edee/c1b63/templates.png 1200w,\n/static/6ae8ea059068618f507cd176d129edee/29007/templates.png 1600w,\n/static/6ae8ea059068618f507cd176d129edee/c2d13/templates.png 2560w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Hope this was helpful. As always feel free to reach out to me if you have questions about this post or want to learn more about RedHat developer hub. I'm so excited about RedHat developer hub and backstage and the value it can add to development teams also what RedHat is doing in this space.</p>\n<p>Thanks,\nRam</p>","id":"cb7c86c4-bde9-59d7-b4ff-acc106a6001c","frontmatter":{"title":"Installing RedHat Developer Hub on Amazon Elastic Kubernetes Service (EKS)","date":"March 16, 2024","tags":["backstage","idp","kubernetes","eks","amazon","redhat"]},"fields":{"slug":"/installing-rhdh-on-eks/"}}},{"node":{"excerpt":"When you use HAProxy Ingress with ArgoCD on Kubernetes you are going to run into this error 'ERR_TOO_MANY_REDIRECTS' when you browse to the ArgoCD server URL. I lost of few hours trying to figure outâ€¦","html":"<p>When you use HAProxy Ingress with ArgoCD on Kubernetes you are going to run into this error 'ERR_TOO_MANY_REDIRECTS' when you browse to the ArgoCD server URL. I lost of few hours trying to figure out what the cause is and wanted to write this up with the hope that it saves some one else time later and also a note for myself so I don't forget exactly what I did to solve the issue.</p>\n<p>I installed ArgoCD server on my EKS cluster following the instructions in the ArgoCD docs using the command below</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kubectcl create namespace gitops\nkubectl apply -n gitops -f https://raw.githubusercontent.com/argoproj/argo-cd/master/manifests/install.yaml</code></pre></div>\n<p>After that I created an Ingress Resource by running the command below</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">cat &lt;&lt;EOF | kubectl apply -f -\napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: argocd\n  namespace: gitops\nspec:\n  ingressClassName: haproxy\n  rules:\n  - host: gitops.sandbox2841.opentlc.com\n    http:\n      paths:\n      - backend:\n          service:\n            name: argocd-server\n            port:\n              name: https\n        path: /\n        pathType: Prefix\n  tls:\n  - hosts:\n    - gitops.sandbox2841.opentlc.com\nEOF</code></pre></div>\n<p>Browse to <code class=\"language-text\">https://gitops.sandbox2841.opentlc.com</code> and started noticing 'ERR_TOO_MANY_REDIRECTS'. reason why this was happening is because HAProxy by default terminates SSL and forwards HTTP to backend service and ArgoCD server when it sees an HTTP traffic it automatically redirects to HTTPS. This results in an infinite loop and eventually HAProxy gives up and you see that error in browser.\nSo to fix this problem I simply had to add an annotation <code class=\"language-text\">ingress.kubernetes.io/ssl-passthrough: \"true\"</code> to the ingress resource so HAProxy instead of terminating HTTPS traffic at the proxy will do an SNI passthrough.</p>\n<p>Updated Ingress resource as shown below</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: argocd\n  namespace: gitops\n  annotations:\n    ingress.kubernetes.io/ssl-passthrough: \"true\"\nspec:\n  ingressClassName: haproxy\n  rules:\n  - host: gitops.sandbox2841.opentlc.com\n    http:\n      paths:\n      - backend:\n          service:\n            name: argocd-server\n            port:\n              name: https\n        path: /\n        pathType: Prefix\n  tls:\n  - hosts:\n    - gitops.sandbox2841.opentlc.com\nEOF</code></pre></div>\n<p>Grab the admin password from kubernetes secret by running command below</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kubectl get secrets argocd-initial-admin-secret -n gitops -o jsonpath=\"{.data.password}\" | base64 -d | pbcopy</code></pre></div>\n<p>Browse to <code class=\"language-text\">https://gitops.sandbox2841.opentlc.com</code> enter admin for username and paste the password obtained from previous step and you will be logged into ArgoCD server successfully as shown in screen capture below</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9ea613f81a97d2d066809a1501b42380/12e1b/argocd.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABhElEQVR42pWQu0oDURCGt40gWlmKCqKNgkSENIIvIHa2lj6ZLyAoKSw06qrEJOayJCa7m83er7nauMn+zjkJooVCio85Z+acj5kRXD+Cb/uwTR+GHcJ0Quh2BMvrw49GHMMK4dDdDUdw/D48FoMBTJdyFG1WC4b0pgvh5OwcmeNTiPkioh4V/ICKERUDxHGMeDym+IkxxfFkgiRJgBkJ3enwnUuSCYTV9CFS6zu4uMwiX2si91rBQ6HK6bgB4cMMurDDHsyIuu6PEPSHxAjhgM69ISec5YW1gyMsbu4he/8Mb/CBtkMSL+TIlsdpme4U4zeNjo1iQ0WxrqKuWTwnrOxkuPDqVoRJXTR1GzJ9Zigk+wuV9i6pBipNDdVWBzXF4DlhaSuN1MYuru9EWDRSy3D+FXEZwSZhXVdIxmjqDjRakbC8vY+FOYSsc0nVaVQZ5XeVutOmUdZQaijzCdlIdc0kSZskCt5IcCMWkM290B5lSIo+f4c/5Wzkp3IdjyWJ/2Nr+AJ7vXGtXdpr+wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"argocd\"\n        title=\"\"\n        src=\"/static/9ea613f81a97d2d066809a1501b42380/5a190/argocd.png\"\n        srcset=\"/static/9ea613f81a97d2d066809a1501b42380/772e8/argocd.png 200w,\n/static/9ea613f81a97d2d066809a1501b42380/e17e5/argocd.png 400w,\n/static/9ea613f81a97d2d066809a1501b42380/5a190/argocd.png 800w,\n/static/9ea613f81a97d2d066809a1501b42380/c1b63/argocd.png 1200w,\n/static/9ea613f81a97d2d066809a1501b42380/29007/argocd.png 1600w,\n/static/9ea613f81a97d2d066809a1501b42380/12e1b/argocd.png 1607w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Hope this helps,</p>\n<p>Thanks,\nRam</p>","id":"2b8c0cb4-6808-5d23-806d-7f23131e082c","frontmatter":{"title":"Fixing error 'ERR_TOO_MANY_REDIRECTS' when using HAProxy with ArgoCD","date":"March 14, 2024","tags":["gitops","argocd","Kubernetes"]},"fields":{"slug":"/haproxy-ingress-with-argocd/"}}},{"node":{"excerpt":"I've been hearing a lot about Crossplane for over a year now and recently I got a chance to try it out, specifically resource composition capabilities. In this post I'll go over how I used theseâ€¦","html":"<p>I've been hearing a lot about Crossplane for over a year now and recently I got a chance to try it out, specifically resource composition capabilities. In this post I'll go over how I used these capabilities to build a system that automates provisioning of EKS clusters in AWS. I hope you are just as excited as I am. What I liked the most is that crossplane allows us to extend kubernetes without really writing single line of go code or having to be expert in kubernetes operators. Everything I'm going to cover here is in <a href=\"https://github.com/rprakashg-redhat/crossplane-eks\">this</a> github repo. Lets jump right into it.</p>\n<p>Provision an EKS cluster by running terraform scripts included in the infra directory in the github repo, this cluster is going to act as a tools cluster where I will be installing crossplane.</p>\n<p>Create the tools cluster by running terraform commands below</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">cd infra\n\nterraform init\nterraform plan\nterraform apply</code></pre></div>\n<p>After terraform commands are completed successfully we can see that the cluster was provisioned and is active from the screen capture below.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a0a0d5ea445cb5a8406ce46d2b5ba3e1/63b67/ekscrossplane.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 14.500000000000002%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAjUlEQVR42k3MSw7CMAwE0N7/UhyBLUuEEKI0bYiTOr8mQ2JoxeLJ9tjyoOYFz9eE2/2B3k9q/qs/6mtued/ts5gURqUxXs8YLycMMSWEEKANIeUsOHjkbZM8xohSCmqpWD03rt0kyXYhJmRPyLxgqLWCmeUhOQfbGKKjkrXSd5reWIyGsXRkndysDMseH5B35hYtJ1h7AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"crossplaneeks\"\n        title=\"\"\n        src=\"/static/a0a0d5ea445cb5a8406ce46d2b5ba3e1/5a190/ekscrossplane.png\"\n        srcset=\"/static/a0a0d5ea445cb5a8406ce46d2b5ba3e1/772e8/ekscrossplane.png 200w,\n/static/a0a0d5ea445cb5a8406ce46d2b5ba3e1/e17e5/ekscrossplane.png 400w,\n/static/a0a0d5ea445cb5a8406ce46d2b5ba3e1/5a190/ekscrossplane.png 800w,\n/static/a0a0d5ea445cb5a8406ce46d2b5ba3e1/c1b63/ekscrossplane.png 1200w,\n/static/a0a0d5ea445cb5a8406ce46d2b5ba3e1/29007/ekscrossplane.png 1600w,\n/static/a0a0d5ea445cb5a8406ce46d2b5ba3e1/63b67/ekscrossplane.png 2447w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Install crossplane using helm chart. This is pretty well documented <a href=\"https://docs.crossplane.io/v1.14/software/install/\">here</a></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">helm repo update\n\nhelm install crossplane \\\n    crossplane<span class=\"token punctuation\">-</span>stable/crossplane \\\n    <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>namespace crossplane<span class=\"token punctuation\">-</span>system \\\n    <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>create<span class=\"token punctuation\">-</span>namespace</code></pre></div>\n<p>Lets verify that the crossplane pods are running and healthy</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">kubectl get pods <span class=\"token punctuation\">-</span>n crossplane<span class=\"token punctuation\">-</span>system</code></pre></div>\n<p>and we can see that all crossplane system pods are up and running</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5d70a69e0bc5d09f64c1d32e106a8699/2c118/crossplanesystem.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 8%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAfUlEQVR42kXKuw6CMBiA0b+WqfciVYjBiPImJmIY3dT3f47PhsXhbEeGYaA/HjC2ReyjWlBhrZ4ov6DjSj5/sP2LePpi7jPt22OuFlMMKSWcc3jv6boOmaaJcRwppbBvQxXZ7RQistFa12zIOTHfLgQXaKQh+kiOeTtK/f8P87kw0ePCGIcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"crossplanesystem\"\n        title=\"\"\n        src=\"/static/5d70a69e0bc5d09f64c1d32e106a8699/5a190/crossplanesystem.png\"\n        srcset=\"/static/5d70a69e0bc5d09f64c1d32e106a8699/772e8/crossplanesystem.png 200w,\n/static/5d70a69e0bc5d09f64c1d32e106a8699/e17e5/crossplanesystem.png 400w,\n/static/5d70a69e0bc5d09f64c1d32e106a8699/5a190/crossplanesystem.png 800w,\n/static/5d70a69e0bc5d09f64c1d32e106a8699/c1b63/crossplanesystem.png 1200w,\n/static/5d70a69e0bc5d09f64c1d32e106a8699/2c118/crossplanesystem.png 1505w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Install following crossplane AWS providers shown below. Providers enable crossplane to provision infrastructure on an external service. For more info on other providers including the AWS ones listed below checkout <a href=\"https://marketplace.upbound.io/providers\">https://marketplace.upbound.io/providers</a></p>\n<ul>\n<li><a href=\"https://marketplace.upbound.io/providers/upbound/provider-aws-ec2/v0.47.1\">ec2</a></li>\n<li><a href=\"https://marketplace.upbound.io/providers/upbound/provider-aws-kms/v0.47.1\">kms</a></li>\n<li><a href=\"https://marketplace.upbound.io/providers/upbound/provider-aws-iam/v0.47.1\">iam</a></li>\n<li><a href=\"https://marketplace.upbound.io/providers/upbound/provider-aws-eks/v0.47.1\">eks</a></li>\n</ul>\n<p>Install a go templating composition function which I'll use when defining resource composition for the composite API we will define later in this post. For more information about this function check out the upbound marketplace <a href=\"https://marketplace.upbound.io/functions/crossplane-contrib/function-go-templating/v0.4.1\">https://marketplace.upbound.io/functions/crossplane-contrib/function-go-templating/v0.4.1</a></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">cat &lt;&lt;EOF <span class=\"token punctuation\">|</span> kubectl apply <span class=\"token punctuation\">-</span>f <span class=\"token punctuation\">-</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> pkg.crossplane.io/v1beta1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Function\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> function<span class=\"token punctuation\">-</span>go<span class=\"token punctuation\">-</span>templating\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">package</span><span class=\"token punctuation\">:</span> xpkg.upbound.io/upbound/function<span class=\"token punctuation\">-</span>go<span class=\"token punctuation\">-</span>templating<span class=\"token punctuation\">:</span>v0.4.1\nEOF</code></pre></div>\n<p>verify that the function was installed successfully and running healthy.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">kubectl get function</code></pre></div>\n<p>Setup cloud provider credentials. Run command below to create a credentials file. Be sure to create an IAM account with required privileges and set the environment variables referenced in the below command with respective values that match your environment.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">echo \"[default] \\naws_access_key_id = ${AWS_ACCESS_KEY_ID}\\naws_secret_access_key = ${AWS_SECRET_ACCESS_KEY}\" > aws-credentials.txt</code></pre></div>\n<p><strong><em>Be sure to not checkin the <code class=\"language-text\">aws-credentials.txt</code> file to github by including an entry in your <code class=\"language-text\">.gitignore</code> file to ignore it</em></strong></p>\n<p>Create a kubernetes secret from <code class=\"language-text\">aws-credentials.txt</code> file by running command below</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kubectl create secret \\\n    generic aws-secret \\\n    -n crossplane-system \\\n    --from-file=creds=./aws-credentials.txt</code></pre></div>\n<p>Create a provider config resource to customize the settings of the AWS provider. Basically this is how we tell the crossplane AWS provider how to authenticate with AWS.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">cat &lt;&lt;EOF <span class=\"token punctuation\">|</span> kubectl apply <span class=\"token punctuation\">-</span>f <span class=\"token punctuation\">-</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> aws.upbound.io/v1beta1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ProviderConfig\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aws<span class=\"token punctuation\">-</span>config\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">credentials</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">source</span><span class=\"token punctuation\">:</span> Secret\n    <span class=\"token key atrule\">secretRef</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> crossplane<span class=\"token punctuation\">-</span>system\n      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aws<span class=\"token punctuation\">-</span>secret\n      <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> creds\nEOF</code></pre></div>\n<h2>Create Composite Resource Definitions</h2>\n<p>Composite resource definitions (XRDs) allows us to define the schema for custom APIs. All schemas follow kubernetes custom resource definition <a href=\"https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/#specifying-a-structural-schema\">OpenAPIv3 structural schema</a>. Since I want the cluster to be provisioned within its own VPC with public and private subnets and route tables I decided to create 2 custom APIs. 1) Virtualnetwork (Creates VPC with subnets and route tables, Internet Gateway, NAT Gateway, Routing rules). 2) EKSCluster (Creates EKS Clusters with managed nodegroups and virtual network). Both APIs can be found <a href=\"https://github.com/rprakashg-redhat/crossplane-eks/tree/main/apis\">here</a></p>\n<p>Create the XRDs by running the command below.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kubectl apply -f apis/virtualnetwork.yaml\n\nkubectl apply -f apis/ekscluster.yaml</code></pre></div>\n<p>We can verify that the XRD's are created by running <code class=\"language-text\">kubectl get xrd</code></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/26d15dbdc340593d60e4ee19c52fd44b/54c3a/verifyxrd.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 9.499999999999998%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAhUlEQVR42j2MzQqCQBgAv9UFMXVX19T9gYTwED1DxxA61sEuvf9rTELQYRiYw0iMkR+JcejQ1RWT3vjlQxNf9POGO23U4YluH2TNSt6vZPeS7CaoQVHYAmssWmskpYT3nhDC7ony4DiOC9bNSN4yxQuVSbjhjNIdkrV7N4gRpN6HohCRP19FYjFx04gJTQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"verifyxrd\"\n        title=\"\"\n        src=\"/static/26d15dbdc340593d60e4ee19c52fd44b/5a190/verifyxrd.png\"\n        srcset=\"/static/26d15dbdc340593d60e4ee19c52fd44b/772e8/verifyxrd.png 200w,\n/static/26d15dbdc340593d60e4ee19c52fd44b/e17e5/verifyxrd.png 400w,\n/static/26d15dbdc340593d60e4ee19c52fd44b/5a190/verifyxrd.png 800w,\n/static/26d15dbdc340593d60e4ee19c52fd44b/c1b63/verifyxrd.png 1200w,\n/static/26d15dbdc340593d60e4ee19c52fd44b/54c3a/verifyxrd.png 1257w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>Create Compositions</h2>\n<p>Compositions are like a deployment template for provisioning a group of resources as single object. I've defined the composition logic for both virtualnetwork and ekscluster XRDs and will go ahead and create them. In summary all required steps for provisioning VPC with subnets and route tables are defined in the composition for virtualnetwork and all resources that need to be created to have a fully functional eks cluster are defined in the composition for ekscluster XRD. You can see in the composition file I'm basically defining all the managed resources defined in the providers and crossplane takes care of provisioning them in my AWS account. You'll also notice each managed resource has a <code class=\"language-text\">providerConfigRef</code> property that we are using to tell crossplane system how to authenticate with the AWS account which we configured earlier.</p>\n<p>You can also see in the composition for <code class=\"language-text\">ekscluster</code> XRD that I'm nesting the <code class=\"language-text\">VirtualNetwork</code> XRD instead of duplicating all the logic of provisioning VPC, Subnets, route tables etc. By moving that into a seperate XRD allows us to reuse it for other usecases as well</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kubectl apply -f composition/virtualnetwork.yaml\nkubectl apply -f composition/ekscluster.yaml</code></pre></div>\n<p>We can see that composition resources are created successfully for our XRDs</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/54af83fc5bedb03e4ac1110a02240831/9ba38/composition.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 10.999999999999998%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAgUlEQVR42lXMywqCQBiA0R80yhoHZ8RM0HEEYVwG4i6Qrvj+L/Rl7lqc7ZEQAs65TVVdyLKcLiyUbuagrzT9m25YODczupgwxY1955BBkFyIjhE61RhjSJIE+UXe+zVssdagUkPpF7LqSawmCvchr18bWz9Q9s6ub5FxzU4xIvLnC5AoM3PDbbQMAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"compositions\"\n        title=\"\"\n        src=\"/static/54af83fc5bedb03e4ac1110a02240831/5a190/composition.png\"\n        srcset=\"/static/54af83fc5bedb03e4ac1110a02240831/772e8/composition.png 200w,\n/static/54af83fc5bedb03e4ac1110a02240831/e17e5/composition.png 400w,\n/static/54af83fc5bedb03e4ac1110a02240831/5a190/composition.png 800w,\n/static/54af83fc5bedb03e4ac1110a02240831/c1b63/composition.png 1200w,\n/static/54af83fc5bedb03e4ac1110a02240831/9ba38/composition.png 1329w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>Creating an EKS cluster</h2>\n<p>We can now create an EKS cluster by simply running command below</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">cat &lt;&lt;EOF | kubectl apply -f -\napiVersion: stacks.aws.io/v1alpha1\nkind: EKSCluster\nmetadata:\n  name: crossplane-eks-cluster\nspec:\n  region: \"us-west-1\"\n  version: \"1.27\"\n  compute:\n    nodeGroups:\n    - name: default\n      instanceType: t3.medium\n      scaling:\n        minSize: 2\n        maxSize: 3\n        desiredSize: 2\n  availabilityZones:\n  - us-west-1a\n  - us-west-1c\n  networking:\n    name: crossplane-eks-cluster-vpc\n    cidr: 10.0.0.0/16\n    publicSubnet:\n      cidr:\n      - 10.0.3.0/24\n      - 10.0.4.0/24\n    privateSubnet:\n      cidr:\n      - 10.0.1.0/24\n      - 10.0.2.0/24\nEOF</code></pre></div>\n<p>To see a list of managed resources that are created and their status we can run <code class=\"language-text\">kubectl get managed</code></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b31cce763de8128348beb4a33a705cff/07d7d/managed.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 65.49999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAABk0lEQVR42n2T2ZKCUBBD3ZUdFARcAMHSUuf/fy/D6ar7Mo4+pJqLTTrpXCd1XWu/32u3KxRm9xEP+cldwViT4ke7V636VqmqaiVJotlspslk8hlVVSmKIsVxpDTxDUnsKwzWisKNYi9SnuU6Ho/K89xA/3q9NrwRXq9XDcNgHwzjc9t16vtBTdupG9EPvcqq1Ha7NYX0Px4PdWMf5zfCsiwVhuGoMLYGKkAFZyounMLNZmO2V6vV//aLolCWZaYApGk67nMn3rNb3jHQ9315nmfgOQgCzefzd0JCcbuBBDI3gOpCa5rGfmfgYrH4HAqNp9PJwPPhcDB75/PZhmAb4rZtx932NmC5XH5PGflub4AzNlGJYiq7JlV29/Xa0IiNv3sELhiU4gByBn+9i+zHpexUcmYAZFhkBc4FKqfT6WdCppMaJM6qSxRyFBMG5ID3EDqgFpC4DeKismwCuVwutnwqoWATMgbhhOHP59N6XP/tdtPr9bKLbumTKs3skoCofIhlyFCIZapT7P56XHLc8OwU/gIkHi9txZ0KrQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"managed\"\n        title=\"\"\n        src=\"/static/b31cce763de8128348beb4a33a705cff/5a190/managed.png\"\n        srcset=\"/static/b31cce763de8128348beb4a33a705cff/772e8/managed.png 200w,\n/static/b31cce763de8128348beb4a33a705cff/e17e5/managed.png 400w,\n/static/b31cce763de8128348beb4a33a705cff/5a190/managed.png 800w,\n/static/b31cce763de8128348beb4a33a705cff/c1b63/managed.png 1200w,\n/static/b31cce763de8128348beb4a33a705cff/07d7d/managed.png 1478w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>When <code class=\"language-text\">READY</code> and <code class=\"language-text\">SYNCED</code> for all managed resources show value 'True' this means that everything was provisioned successfully in AWS. If you see it stuck in False we can run <code class=\"language-text\">kubectl describe {replace with managed resource}</code> to see more details about why its stuck.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c001eba8adbd7c9293c346acb77424f4/2dab4/managed1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 67.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAABrklEQVR42n2TS3OCQBCE8YkgKgqKCIKPWB58VE45pFLJIf//N3X4tjKpVDQeurZ2YXt6ume93W6rqlorWrxpWnwoyV81K96UlZ/Kn19UvRdKskRpkioIA3me9xi+7ysIAkXDvsKg5xD4XQ2HvsajSHEUqywKzWYzjUYj9ft9d7HVajncEB4OB9V1rXqz1abB/unQKK5VlpWKstRyudR0OlWWZQ7X61XH41Hr9bopOrwlTJLEXTCkaao4jp2i+XyuxWKh4lthFEUOKGXtdDq3hFyGiAvAiCk0Ho8dKJLnueuEc4C6uy1TDXDRFEwmE7dfrVZOIWd4jSL8Bt1u934oVC4br2gL4BmAyCzgn9Pp1Hi8cer+JQP4ZIYDiDiDBDsg4Jw9oNV2u/0/oQXw20Nr37wkUbrg7KG634QWjKmiVYDi8nt82OP3Q4W0gCILx4KxtC3ZMAzvz91fQMZFlNkIcWZ7m0cD33ktvV7PrWAwGLjk3Vzu93vn0XbLm65+VhIldVPNKNE+r4Rv/McrO5/Pulwu7l9GyzPvqG7BQIA6lJIs/kFor4Rg8BGgygac9QvyZEaVRDeHbQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"managed\"\n        title=\"\"\n        src=\"/static/c001eba8adbd7c9293c346acb77424f4/5a190/managed1.png\"\n        srcset=\"/static/c001eba8adbd7c9293c346acb77424f4/772e8/managed1.png 200w,\n/static/c001eba8adbd7c9293c346acb77424f4/e17e5/managed1.png 400w,\n/static/c001eba8adbd7c9293c346acb77424f4/5a190/managed1.png 800w,\n/static/c001eba8adbd7c9293c346acb77424f4/c1b63/managed1.png 1200w,\n/static/c001eba8adbd7c9293c346acb77424f4/2dab4/managed1.png 1461w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Additionally you can login to AWS console and verify all resources are successfully provisioned. Screen capture below shows EKS cluster provisioned with default managed node group</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/fda82e59ef9ce5fb4d21224917c7a980/cc6fe/crossplanecluster.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABNElEQVR42mVRB27DMBDz/38RFAmaZbfp+lNaeMinLZm9k53VGiCOoqhbrrbNCc3pC+ttjdV6h832iEPzjv0fPD0fsdrssavfHvSa3x5ePgo/vn6i8jFimia0o8V5ILRkQT5BhwS6h0+Lnq98lJgm2DwVPmiLahwJkZP2SkE7B+cDLEdjLBRpGOdh7Kz3pBgDaw6ez6LLvQ+BEUusApOcM9quxXfb4aftoYYBigv0HAeOwklrBi3Q0OX8HxX4k5GJu7FcMcaAwJUcd5FSKsUE0rV0kHiaGFPxyL1AeF74LSFX9t4vD2IxXaLosgJjTCl00e89TjzWzgk5I7qux5nHLfsqu/TcseXRzNU80lzULTvWXMC72ado5Cnp1qGYiU0xZUZ6gIwqCSVJkAkW/cqj/BBf1vIL9WRe/LbYGnsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"crossplanecluster\"\n        title=\"\"\n        src=\"/static/fda82e59ef9ce5fb4d21224917c7a980/5a190/crossplanecluster.png\"\n        srcset=\"/static/fda82e59ef9ce5fb4d21224917c7a980/772e8/crossplanecluster.png 200w,\n/static/fda82e59ef9ce5fb4d21224917c7a980/e17e5/crossplanecluster.png 400w,\n/static/fda82e59ef9ce5fb4d21224917c7a980/5a190/crossplanecluster.png 800w,\n/static/fda82e59ef9ce5fb4d21224917c7a980/c1b63/crossplanecluster.png 1200w,\n/static/fda82e59ef9ce5fb4d21224917c7a980/29007/crossplanecluster.png 1600w,\n/static/fda82e59ef9ce5fb4d21224917c7a980/cc6fe/crossplanecluster.png 1860w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Browse to VPC in console and verify all resource provisioned. Screen capture below shows VPC that was created by crossplane</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3229cd7e74c98f5b60eb53e65c1a7057/20785/vpc.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA6UlEQVR42q1RXUvEMBDMD/bl4K7qWfVA7oT7o4pc03w2adNm3E2kCPogamCY3dnJEDbi4fmM/eGMTdPianOL7c2B8Ijr9glNe8J2f8SOeHd3XMF6c38qemHWPljEGJHzgpQSxmkCnzTPmDNzwrLUWc651HW+VA/1E/FCszHNxSOkMrDOYwgDOinRK4VLr/FGkFQroyB7BWMttGGvQ0ez1458SuPl0kNqU7gnFhwWQkSgl/IFvsiwBW7tP8M6C7fW1eNc7QWHeD98CfwtREn3/n8DQwhr4F8h+BM4LNIeNS01xvFH4L1/p78DzQJNrHPBLW4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"vpc\"\n        title=\"\"\n        src=\"/static/3229cd7e74c98f5b60eb53e65c1a7057/5a190/vpc.png\"\n        srcset=\"/static/3229cd7e74c98f5b60eb53e65c1a7057/772e8/vpc.png 200w,\n/static/3229cd7e74c98f5b60eb53e65c1a7057/e17e5/vpc.png 400w,\n/static/3229cd7e74c98f5b60eb53e65c1a7057/5a190/vpc.png 800w,\n/static/3229cd7e74c98f5b60eb53e65c1a7057/c1b63/vpc.png 1200w,\n/static/3229cd7e74c98f5b60eb53e65c1a7057/20785/vpc.png 1307w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>So far I'm really liking what I've been able to do with Crossplane, I plan to extend this to be able to define cluster recipes (Small/Medium, Large as an example) so folks requesting cluster don't even have to know anything about networking, compute etc. Also I could have defined XRDs more provider agnostic and not use <code class=\"language-text\">EKS</code>, <code class=\"language-text\">Availability Zone</code> etc in the api spec.</p>\n<p>Hope this post helped spawn new ideas if you are a platform builder or building tools for enterprise.</p>\n<p>As always feel free to reach out if you have any questions about this post</p>\n<p>Thanks,\nRam</p>","id":"e635bc93-9143-5a2b-85af-e6b631ccdc29","frontmatter":{"title":"Automating provisioning of EKS Clusters with Crossplane","date":"January 30, 2024","tags":["Crossplane","AWS","EKS","Tools","Kubernetes"]},"fields":{"slug":"/provisioning-eks-clusters-with-crossplane/"}}}]}},"pageContext":{}},"staticQueryHashes":["1611934721","2366241629"],"slicesMap":{}}