{"componentChunkName":"component---src-templates-blog-post-js","path":"/build_iso_images_for_vpac/","result":{"data":{"site":{"siteMetadata":{"url":"https://rprakashg.github.io","title":"rprakashg.github.io"}},"markdownRemark":{"html":"<p>In my last <a href=\"https://rprakashg.github.io/installing-rhel-using-ipmi/\">post</a> I covered how to perform an IPMI install using a custom ISO but did not go into too much details on how to build a customized ISO for provisioning systems that run virtualized protection and control applications. In this post I will walk through how to use Ansible and Imagebuilder to achieve just that</p>\n<h2>Provisioning a Host Machine as Image Builder</h2>\n<p>First thing we will need to do is provision imagebuilder host machine. I'm going to use a demo AWS environment and provision an EC2 instance using the RHEL 9 AMI provided by Red Hat. I've SSH'd into the host and connected it to Red Hat subscription and have ensure the system is up to date with all the packages. I've also updated my ansible inventory file like below</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">all</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">imagebuilder</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">ansible_host</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"&lt;redacted>\"</span>\n      <span class=\"token key atrule\">ansible_port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">22</span>\n      <span class=\"token key atrule\">ansible_user</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"ec2-user\"</span>\n      <span class=\"token key atrule\">ansible_ssh_private_key_file</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"&lt;redacted>\"</span></code></pre></div>\n<h2>Configuring the Image Builder host</h2>\n<p>To configure the RHEL host as imagebuilder we are going to use this <a href=\"https://github.com/rprakashg/demos/tree/main/roles/setup_imagebuilder\">role</a>. Role leverages infra.osbuild to configure the host as imagebuilder, additionally it add kernel rt and nfv repos to imagebuilder sources so we can install those packages references in the image definition. For more detailed information please checkout ansible code in the role. We are going to run a simple ansible playbook that leverages the role. Playbook looks like below</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Configure RHEL host as image builder \n  <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span> imagebuilder\n  <span class=\"token key atrule\">gather_facts</span><span class=\"token punctuation\">:</span> yes\n\n  <span class=\"token key atrule\">tasks</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Import role\n    <span class=\"token key atrule\">ansible.builtin.import_role</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> rprakashg.vpac.setup_imagebuilder</code></pre></div>\n<p>Next we are going to install the ansible collection as shown in the snippet below</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">ansible-galaxy collection <span class=\"token function\">install</span> git+https://github.com/rprakashg/vpac.git,main</code></pre></div>\n<p>Then we are going to run the playbook as shown in the command below</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">ansible-playbook <span class=\"token parameter variable\">-i</span> inventory setup_imagebuilder.yml</code></pre></div>\n<p>If everything goes well we should see an output like below screen capture</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5c5753ef7cdeb80ec048ef741a77cef4/b5514/setup_imagebuilder.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 88.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAASABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIBBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAeCYAXISD//EABQQAQAAAAAAAAAAAAAAAAAAADD/2gAIAQEAAQUCH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EABQQAQAAAAAAAAAAAAAAAAAAADD/2gAIAQEABj8CH//EABgQAAIDAAAAAAAAAAAAAAAAAAEQABEx/9oACAEBAAE/IblosbDq/9oADAMBAAIAAwAAABCwADz/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/EB//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/EB//xAAaEAEBAQEBAQEAAAAAAAAAAAABACERMUFx/9oACAEBAAE/EFDjKfs+3rLZ7Ho7u2V+zf/Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"setup_imagebuilder\"\n        title=\"\"\n        src=\"/static/5c5753ef7cdeb80ec048ef741a77cef4/4b190/setup_imagebuilder.jpg\"\n        srcset=\"/static/5c5753ef7cdeb80ec048ef741a77cef4/e07e9/setup_imagebuilder.jpg 200w,\n/static/5c5753ef7cdeb80ec048ef741a77cef4/066f9/setup_imagebuilder.jpg 400w,\n/static/5c5753ef7cdeb80ec048ef741a77cef4/4b190/setup_imagebuilder.jpg 800w,\n/static/5c5753ef7cdeb80ec048ef741a77cef4/e5166/setup_imagebuilder.jpg 1200w,\n/static/5c5753ef7cdeb80ec048ef741a77cef4/b17f8/setup_imagebuilder.jpg 1600w,\n/static/5c5753ef7cdeb80ec048ef741a77cef4/b5514/setup_imagebuilder.jpg 2062w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>Building a standardized custom image for provisioning RHEL based systems that run virtualized protection and control applications</h2>\n<p>Now that the imagebuilder server is configured and running we can now use it to build a standardized custom image with an anaconda kickstart file that automates provisioning RHEL based systems for deploying virtualization protection and control applications. Lets now look at how we are going to achieve that.</p>\n<h3>Defining a standardized base image</h3>\n<p>First thing we will need to do is to define a standardized base image. We can achieve this by creating an ansible vars file. Image definition looks like the below yaml snippet.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">retries</span><span class=\"token punctuation\">:</span> <span class=\"token number\">100</span>\n<span class=\"token key atrule\">delay</span><span class=\"token punctuation\">:</span> <span class=\"token number\">20</span>\n\n<span class=\"token comment\"># blueprint details</span>\n<span class=\"token key atrule\">builder_blueprint_name</span><span class=\"token punctuation\">:</span> RHEL<span class=\"token punctuation\">-</span>9<span class=\"token punctuation\">-</span>6<span class=\"token punctuation\">-</span>Base\n<span class=\"token key atrule\">builder_blueprint_description</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Base RHEL 9.6 for virtualization host\"</span>\n<span class=\"token key atrule\">builder_blueprint_distro</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"rhel-9\"</span>\n<span class=\"token key atrule\">builder_compose_pkgs</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">-</span> ansible<span class=\"token punctuation\">-</span>core\n<span class=\"token punctuation\">-</span> wget\n<span class=\"token punctuation\">-</span> firewalld\n<span class=\"token punctuation\">-</span> rhel<span class=\"token punctuation\">-</span>system<span class=\"token punctuation\">-</span>roles\n<span class=\"token punctuation\">-</span> cockpit\n<span class=\"token punctuation\">-</span> cockpit<span class=\"token punctuation\">-</span>machines\n<span class=\"token punctuation\">-</span> cockpit<span class=\"token punctuation\">-</span>podman\n<span class=\"token punctuation\">-</span> cloud<span class=\"token punctuation\">-</span>init\n<span class=\"token punctuation\">-</span> cloud<span class=\"token punctuation\">-</span>utils<span class=\"token punctuation\">-</span>growpart\n<span class=\"token punctuation\">-</span> unzip\n<span class=\"token punctuation\">-</span> bzip2\n<span class=\"token punctuation\">-</span> zstd\n<span class=\"token punctuation\">-</span> mkisofs\n<span class=\"token punctuation\">-</span> qemu<span class=\"token punctuation\">-</span>kvm\n<span class=\"token punctuation\">-</span> libvirt\n<span class=\"token punctuation\">-</span> virt<span class=\"token punctuation\">-</span>install\n<span class=\"token punctuation\">-</span> virt<span class=\"token punctuation\">-</span>viewer\n<span class=\"token punctuation\">-</span> swtpm\n<span class=\"token punctuation\">-</span> swtpm<span class=\"token punctuation\">-</span>tools\n<span class=\"token punctuation\">-</span> dosfstools\n<span class=\"token punctuation\">-</span> edk2<span class=\"token punctuation\">-</span>ovmf <span class=\"token comment\">#uefi firmware for windows 11 install</span>\n<span class=\"token punctuation\">-</span> kernel<span class=\"token punctuation\">-</span>rt\n<span class=\"token punctuation\">-</span> kernel<span class=\"token punctuation\">-</span>rt<span class=\"token punctuation\">-</span>kvm\n<span class=\"token punctuation\">-</span> tuned<span class=\"token punctuation\">-</span>profiles<span class=\"token punctuation\">-</span>nfv<span class=\"token punctuation\">-</span>host\n<span class=\"token punctuation\">-</span> realtime<span class=\"token punctuation\">-</span>tests\n<span class=\"token punctuation\">-</span> dnf<span class=\"token punctuation\">-</span>plugins<span class=\"token punctuation\">-</span>core\n<span class=\"token punctuation\">-</span> python3<span class=\"token punctuation\">-</span>dnf<span class=\"token punctuation\">-</span>plugin<span class=\"token punctuation\">-</span>versionlock <span class=\"token comment\">#versionlock </span>\n<span class=\"token key atrule\">builder_compose_customizations</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"cockpit.socket\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"firewalld\"</span><span class=\"token punctuation\">]</span>\n  <span class=\"token key atrule\">firewall</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"http\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"https\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"ssh\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"cockpit\"</span><span class=\"token punctuation\">]</span>\n      <span class=\"token key atrule\">disabled</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"telnet\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"9090:tcp\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"22:tcp\"</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\"># Kickstart customizations</span>\n<span class=\"token key atrule\">builder_kickstart_options</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">-</span> lang en_US.UTF<span class=\"token punctuation\">-</span><span class=\"token number\">8</span>\n<span class=\"token punctuation\">-</span> keyboard us\n<span class=\"token punctuation\">-</span> timezone America/Los_Angeles <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>utc\n<span class=\"token punctuation\">-</span> text\n<span class=\"token punctuation\">-</span> liveimg <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>url file<span class=\"token punctuation\">:</span>///run/install/repo/liveimg.tar.gz\n<span class=\"token punctuation\">-</span> zerombr <span class=\"token comment\"># Clear the MBR/GPT on all detected disks</span>\n<span class=\"token punctuation\">-</span> bootloader <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>location=mbr\n<span class=\"token punctuation\">-</span> clearpart <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>all <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>initlabel <span class=\"token comment\"># Clears all partitions on sda and initializes the disk label</span>\n<span class=\"token punctuation\">-</span> part /boot <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>fstype=ext4 <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>size=4096 <span class=\"token comment\"># Creates a /boot partition with ext4 filesystem, 4GB size to accomodate multiple kernels</span>\n<span class=\"token punctuation\">-</span> part /boot/efi <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>fstype=efi <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>size=600\n<span class=\"token punctuation\">-</span> part pv.01 <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>size=1 <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>grow <span class=\"token comment\"># Create a physical volume for LVM</span>\n<span class=\"token punctuation\">-</span> <span class=\"token comment\"># Setup LVM</span>\n<span class=\"token punctuation\">-</span> volgroup vg_system pv.01\n<span class=\"token punctuation\">-</span> logvol / <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>vgname=vg_system <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>name=lv_root <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>fstype=xfs <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>size=150000\n<span class=\"token punctuation\">-</span> logvol /home <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>vgname=vg_system <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>name=lv_home <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>fstype=xfs <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>size=200000\n<span class=\"token punctuation\">-</span> logvol /vms <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>vgname=vg_system <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>name=lv_vms <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>fstype=xfs <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>size=500000\n<span class=\"token punctuation\">-</span> logvol swap <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>vgname=vg_system <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>name=lv_swap <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>recommended\n<span class=\"token punctuation\">-</span> network <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>bootproto=dhcp <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>activate <span class=\"token comment\">#auto detect network</span>\n<span class=\"token punctuation\">-</span> reboot <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>eject\n\n<span class=\"token comment\"># cloudinit</span>\n<span class=\"token key atrule\">hostname</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"vpac-rhel\"</span></code></pre></div>\n<p>Snippet above is pretty self explanatory so I won't go into too much details. Customize the above image definition to fit to your needs.</p>\n<h2>Building a custom ISO using the standardized image definition above</h2>\n<p>Next we will build a custom ISO using the standardized image definition we created earlier. Steps to automate this is implemented in this ansible <a href=\"https://github.com/rprakashg/vpac/tree/main/roles/build_iso\">role</a> in <a href=\"https://github.com/rprakashg/vpac\">vpac</a> ansible collection.</p>\n<p>Below you will find description of the settable variables for this role.</p>\n<table>\n<thead>\n<tr>\n<th>Variable Name</th>\n<th>Purpose</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>retries</td>\n<td>Number of retries for compose job status</td>\n</tr>\n<tr>\n<td>delay</td>\n<td>delay between retries for compose job status</td>\n</tr>\n<tr>\n<td>skip_blueprint_creation</td>\n<td>Flag to turn off blueprint creation. Useful when you haven't made any changes</td>\n</tr>\n<tr>\n<td>skip_compose</td>\n<td>Skip starting a new compose job, useful when you want to leverage artifacts from an existing compose job. If this is set to true then compose_job_id variable is required.</td>\n</tr>\n<tr>\n<td>compose_job_id</td>\n<td>Compose job id, this is automatically set when compose job is triggered. If compose job is skipped then the compose job id must be passed as value</td>\n</tr>\n<tr>\n<td>builder_blueprint_name</td>\n<td>osbuild blueprint name</td>\n</tr>\n<tr>\n<td>builder_blueprint_description</td>\n<td>osbuild blueprint description</td>\n</tr>\n<tr>\n<td>builder_blueprint_distro</td>\n<td>RHEL distro to use</td>\n</tr>\n<tr>\n<td>builder_compose_pkgs</td>\n<td>additional packages that need to be included</td>\n</tr>\n<tr>\n<td>builder_compose_customizations</td>\n<td>Customizations</td>\n</tr>\n<tr>\n<td>builder_kickstart_options</td>\n<td>Anaconda kickstart options to include</td>\n</tr>\n</tbody>\n</table>\n<p>When the role is executed the first thing we do is create a image builder blueprint based on the image definition in ansible vars file. If you have not made any changes to blueprint you can skip this by setting <code class=\"language-text\">skip_blueprint_creation</code> to true. To create the image builder blueprint, the role leverages <a href=\"https://github.com/redhat-cop/infra.osbuild/blob/main/plugins/modules/create_blueprint.py\">create_blueprint</a> plugin from infra.osbuild collection.</p>\n<p>Next step is to start an <code class=\"language-text\">image-installer</code> compose job using the blueprint to build a custom ISO and wait for the compose job to finish. When no changes have been made to blueprint and you have a pre-existing compose job that completed successfully you can skip the compose job by setting <code class=\"language-text\">skip_compose</code> to <code class=\"language-text\">true</code> and specify the job id of previously completed compose job you want to use in variable <code class=\"language-text\">compose_job_id</code></p>\n<p>Once the compose job is successfully completed, ISO artifact file is downloaded into a temp directory. Role then creates cloud-init files to perform first boot initialization steps like creating an admin user and setting the SSH key for the admin user. Additionally an anaconda kickstart file is generated using the kickstart options defined in the ansible vars file. Once the cloud init and kickstart files are generated we inject these into the ISO we downloaded earlier and create a customized ISO. For the purposes of this post I'm injecting the cloud init files also into ISO but ideally you'd want to create a seperate ISO and mount both ISO files while provisioning the system and you would just need to read the cloud init files from the mounted directory path for the cloud init iso.</p>\n<h2>Create an ansible vault to store sensive secrets</h2>\n<p>As mentioned earlier creating cloud init files require sensive information like admin password, ssh key to use etc which are read from an ansible vault. We are going to create the ansbile vault by running command below</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">ansible-vault create vars/secrets.yml</code></pre></div>\n<p>and include this snippet below</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">root_password</span><span class=\"token punctuation\">:</span> &lt;redacted<span class=\"token punctuation\">></span>\n<span class=\"token key atrule\">rh_user</span><span class=\"token punctuation\">:</span> &lt;redacted<span class=\"token punctuation\">></span>\n<span class=\"token key atrule\">rh_user_password</span><span class=\"token punctuation\">:</span> &lt;redacted<span class=\"token punctuation\">></span>\n<span class=\"token key atrule\">admin_user</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'admin'</span>\n<span class=\"token key atrule\">admin_user_password</span><span class=\"token punctuation\">:</span> &lt;redacted<span class=\"token punctuation\">></span>\n<span class=\"token key atrule\">admin_user_ssh_key</span><span class=\"token punctuation\">:</span> &lt;redacted<span class=\"token punctuation\">></span> </code></pre></div>\n<h2>Create an ansible playbook that leverages the build_iso role</h2>\n<p>We can now create an ansible playbook that leverages the <a href=\"https://github.com/rprakashg/vpac/tree/main/roles/build_iso\">build_iso</a> role in the <a href=\"https://github.com/rprakashg/vpac\">collection</a></p>\n<p>See ansible code in the yaml snippet below</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">---</span>\n<span class=\"token comment\"># This playbook builds ISO with kickstart for unattended </span>\n<span class=\"token comment\"># installation of RHEL on Baremetal host for virtualization</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build ISO\n  <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span> imagebuilder\n  <span class=\"token key atrule\">become</span><span class=\"token punctuation\">:</span> yes\n  <span class=\"token key atrule\">gather_facts</span><span class=\"token punctuation\">:</span> yes\n\n  <span class=\"token key atrule\">tasks</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Start\n    <span class=\"token key atrule\">ansible.builtin.debug</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">msg</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Starting ISO build\"</span>\n  \n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Load secrets from ansible vault\n    <span class=\"token key atrule\">ansible.builtin.include_vars</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">file</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"./vars/secrets.yml\"</span>\n\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build ISO\n    <span class=\"token key atrule\">ansible.builtin.import_role</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> rprakashg.vpac.build_iso</code></pre></div>\n<p>If everything goes well we should see the playbook completed successfully without errors and see an output like the screen capture below.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/049c7da835811c8eefd5281e90e71aa4/856de/build_iso.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAECBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHBm5RDF//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEAAQUCX//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABYQAQEBAAAAAAAAAAAAAAAAAAEQAP/aAAgBAQABPyGgOZ//2gAMAwEAAgADAAAAEPQP/8QAFREBAQAAAAAAAAAAAAAAAAAAARD/2gAIAQMBAT8QCf/EABURAQEAAAAAAAAAAAAAAAAAABEQ/9oACAECAQE/EAn/xAAZEAEAAwEBAAAAAAAAAAAAAAABABARMSH/2gAIAQEAAT8Q0j1pg06zwuV//9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"build_iso\"\n        title=\"\"\n        src=\"/static/049c7da835811c8eefd5281e90e71aa4/4b190/build_iso.jpg\"\n        srcset=\"/static/049c7da835811c8eefd5281e90e71aa4/e07e9/build_iso.jpg 200w,\n/static/049c7da835811c8eefd5281e90e71aa4/066f9/build_iso.jpg 400w,\n/static/049c7da835811c8eefd5281e90e71aa4/4b190/build_iso.jpg 800w,\n/static/049c7da835811c8eefd5281e90e71aa4/e5166/build_iso.jpg 1200w,\n/static/049c7da835811c8eefd5281e90e71aa4/b17f8/build_iso.jpg 1600w,\n/static/049c7da835811c8eefd5281e90e71aa4/856de/build_iso.jpg 3584w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Since the custom ISO is in an Ansible temp directory we can ssh into the image builder host and move it to a directory under <code class=\"language-text\">/home</code> using command below</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token function\">sudo</span> <span class=\"token function\">mv</span> <span class=\"token operator\">&lt;</span>custom iso path printed by the ansible role<span class=\"token operator\">></span> <span class=\"token builtin class-name\">.</span></code></pre></div>\n<p>We can now download this file from the image builder host and perform IPMI based installation for provisioning virtualization hosts that run virtualized protection and control applications.</p>\n<p>Hope this post was helpful, as always feel free to reach out to me if you have any questions about this post.</p>\n<p>Thanks,</p>\n<p>Ram</p>","frontmatter":{"title":"Using ansible and image builder to create customized RHEL system images for provisioning systems that run virtualized protection and control software","date":"November 17, 2025","tags":["OS","RHEL","Linux","ImageBuilder"],"author":"Ram Gopinathan"}}},"pageContext":{"slug":"/build_iso_images_for_vpac/"}},"staticQueryHashes":["1611934721","2366241629"],"slicesMap":{}}