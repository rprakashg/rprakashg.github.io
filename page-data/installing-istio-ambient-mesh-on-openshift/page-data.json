{"componentChunkName":"component---src-templates-blog-post-js","path":"/installing-istio-ambient-mesh-on-openshift/","result":{"data":{"site":{"siteMetadata":{"url":"https://rprakashg.github.io","title":"rprakashg.github.io"}},"markdownRemark":{"html":"<p>I recently got a chance to install Istio ambient mesh on OpenShift and ran into couple of issues.  In this post I will walk through steps to get through the installation issues. This is the <a href=\"https://istio.io/latest/docs/ops/ambient/getting-started/\">article</a> I followed to install Ambient Mesh on OpenShift Container Platform</p>\n<p>First thing you are going to run into is ztunnel and istio cni installation failures.</p>\n<h2>Fixing z-tunnel errors</h2>\n<p>You will see an error like below, this is mainly because by default everything runs in openshift in least privilege mode. We can fix these errors by assigning additional SCC's to the service account associated with the ztunnel POD</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Error creating: pods \"ztunnel-\" is forbidden: unable to validate against any security context constraint: [provider \"anyuid\": Forbidden: not usable by user or serviceaccount, provider restricted-v2: .containers[0].runAsUser: Invalid value: 0: must be in the ranges: [1000680000, 1000689999], provider restricted-v2: .containers[0].capabilities.add: Invalid value: \"NET_ADMIN\": capability may not be added, provider \"restricted\": Forbidden: not usable by user or serviceaccount, provider \"nonroot-v2\": Forbidden: not usable by user or serviceaccount, provider \"nonroot\": Forbidden: not usable by user or serviceaccount, provider \"hostmount-anyuid\": Forbidden: not usable by user or serviceaccount, provider \"machine-api-termination-handler\": Forbidden: not usable by user or serviceaccount, provider \"hostnetwork-v2\": Forbidden: not usable by user or serviceaccount, provider \"hostnetwork\": Forbidden: not usable by user or serviceaccount, provider \"hostaccess\": Forbidden: not usable by user or serviceaccount, provider \"node-exporter\": Forbidden: not usable by user or serviceaccount, provider \"privileged\": Forbidden: not usable by user or serviceaccount]</code></pre></div>\n<p>Assign additional security context constraints to <code class=\"language-text\">ztunnel</code> service account on <code class=\"language-text\">istio-system</code> namespace by running commands below</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">oc adm policy add-scc-to-user hostmount-anyuid --serviceaccount ztunnel --namespace istio-system\noc adm policy add-scc-to-user anyuid --serviceaccount ztunnel --namespace istio-system\noc adm policy add-scc-to-user nonroot-v2 --serviceaccount ztunnel --namespace istio-system\noc adm policy add-scc-to-user hostnetwork-v2 --serviceaccount ztunnel --namespace istio-system\noc adm policy add-scc-to-user restricted-v2 --serviceaccount ztunnel --namespace istio-system\noc adm policy add-scc-to-user machine-api-termination-handler --serviceaccount ztunnel --namespace istio-system\noc adm policy add-scc-to-user hostnetwork --serviceaccount ztunnel --namespace istio-system\noc adm policy add-scc-to-user hostaccess --serviceaccount ztunnel --namespace istio-system\noc adm policy add-scc-to-user node-exporter --serviceaccount ztunnel --namespace istio-system\noc adm policy add-scc-to-user privileged --serviceaccount ztunnel --namespace istio-system</code></pre></div>\n<h2>Fixing istio-cni-node errors</h2>\n<p>Similar to z-tunnel you will see these errors shown below. We can fix these errors by assigning additional SCC's to service account associated with istio-cni-node POD</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Error creating: pods \"istio-cni-node-\" is forbidden: unable to validate against any security context constraint: [provider \"anyuid\": Forbidden: not usable by user or serviceaccount, provider restricted-v2: .spec.securityContext.hostNetwork: Invalid value: true: Host network is not allowed to be used, spec.volumes[0]: Invalid value: \"hostPath\": hostPath volumes are not allowed to be used, spec.volumes[1]: Invalid value: \"hostPath\": hostPath volumes are not allowed to be used, spec.volumes[2]: Invalid value: \"hostPath\": hostPath volumes are not allowed to be used, spec.volumes[3]: Invalid value: \"hostPath\": hostPath volumes are not allowed to be used, spec.volumes[4]: Invalid value: \"hostPath\": hostPath volumes are not allowed to be used, provider restricted-v2: .containers[0].runAsUser: Invalid value: 0: must be in the ranges: [1000680000, 1000689999], provider restricted-v2: .containers[0].privileged: Invalid value: true: Privileged containers are not allowed, provider restricted-v2: .containers[0].hostNetwork: Invalid value: true: Host network is not allowed to be used, provider \"restricted\": Forbidden: not usable by user or serviceaccount, provider \"nonroot-v2\": Forbidden: not usable by user or serviceaccount, provider \"nonroot\": Forbidden: not usable by user or serviceaccount, provider \"hostmount-anyuid\": Forbidden: not usable by user or serviceaccount, provider \"machine-api-termination-handler\": Forbidden: not usable by user or serviceaccount, provider \"hostnetwork-v2\": Forbidden: not usable by user or serviceaccount, provider \"hostnetwork\": Forbidden: not usable by user or serviceaccount, provider \"hostaccess\": Forbidden: not usable by user or serviceaccount, provider \"node-exporter\": Forbidden: not usable by user or serviceaccount, provider \"privileged\": Forbidden: not usable by user or serviceaccount]</code></pre></div>\n<p>Assign SCC's to <code class=\"language-text\">istio-cni</code> service account on <code class=\"language-text\">istio-system</code> namespace by running commands below</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">oc adm policy add-scc-to-user anyuid --serviceaccount istio-cni --namespace istio-system\noc adm policy add-scc-to-user restricted-v2 --serviceaccount istio-cni --namespace istio-system\noc adm policy add-scc-to-user restricted --serviceaccount istio-cni --namespace istio-system\noc adm policy add-scc-to-user nonroot-v2 --serviceaccount istio-cni --namespace istio-system \noc adm policy add-scc-to-user nonroot --serviceaccount istio-cni --namespace istio-system\noc adm policy add-scc-to-user hostmount-anyuid --serviceaccount istio-cni --namespace istio-system \noc adm policy add-scc-to-user machine-api-termination-handler --serviceaccount istio-cni --namespace istio-system\noc adm policy add-scc-to-user hostnetwork-v2 --serviceaccount istio-cni --namespace istio-system\noc adm policy add-scc-to-user hostnetwork --serviceaccount istio-cni --namespace istio-system\noc adm policy add-scc-to-user hostaccess --serviceaccount istio-cni --namespace istio-system\noc adm policy add-scc-to-user node-exporter --serviceaccount istio-cni --namespace istio-system\n</code></pre></div>\n<h2>Fixing Istio Ingress Gateway errors</h2>\n<p>Ingress gateway deployment is also going to get stuck due to errors below. We can fix them by assigning additional SCC's to service account associated with istio ingress gateway POD</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Error creating: pods \"istio-ingressgateway-75767568b7-\" is forbidden: unable to validate against any security context constraint: [provider \"anyuid\": Forbidden: not usable by user or serviceaccount, provider restricted-v2: .containers[0].runAsUser: Invalid value: 1337: must be in the ranges: [1000680000, 1000689999], provider \"restricted\": Forbidden: not usable by user or serviceaccount, provider \"nonroot-v2\": Forbidden: not usable by user or serviceaccount, provider \"nonroot\": Forbidden: not usable by user or serviceaccount, provider \"hostmount-anyuid\": Forbidden: not usable by user or serviceaccount, provider \"machine-api-termination-handler\": Forbidden: not usable by user or serviceaccount, provider \"hostnetwork-v2\": Forbidden: not usable by user or serviceaccount, provider \"hostnetwork\": Forbidden: not usable by user or serviceaccount, provider \"hostaccess\": Forbidden: not usable by user or serviceaccount, provider \"node-exporter\": Forbidden: not usable by user or serviceaccount, provider \"privileged\": Forbidden: not usable by user or serviceaccount]</code></pre></div>\n<p>Assign SCC's to <code class=\"language-text\">istio-ingressgateway-service-account</code> service account on <code class=\"language-text\">istio-system</code> namespace</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">oc adm policy add-scc-to-user anyuid --serviceaccount istio-ingressgateway-service-account --namespace istio-system\noc adm policy add-scc-to-user restricted-v2 --serviceaccount istio-ingressgateway-service-account --namespace istio-system\noc adm policy add-scc-to-user restricted --serviceaccount istio-ingressgateway-service-account --namespace istio-system\noc adm policy add-scc-to-user nonroot-v2 --serviceaccount istio-ingressgateway-service-account --namespace istio-system\noc adm policy add-scc-to-user nonroot --serviceaccount istio-ingressgateway-service-account --namespace istio-system\noc adm policy add-scc-to-user hostmount-anyuid --serviceaccount istio-ingressgateway-service-account --namespace istio-system\noc adm policy add-scc-to-user machine-api-termination-handler --serviceaccount istio-ingressgateway-service-account --namespace istio-system\noc adm policy add-scc-to-user hostnetwork-v2 --serviceaccount istio-ingressgateway-service-account --namespace istio-system\noc adm policy add-scc-to-user hostnetwork --serviceaccount istio-ingressgateway-service-account --namespace istio-system\noc adm policy add-scc-to-user hostaccess --serviceaccount istio-ingressgateway-service-account --namespace istio-system\noc adm policy add-scc-to-user node-exporter --serviceaccount istio-ingressgateway-service-account --namespace istio-system\noc adm policy add-scc-to-user privileged --serviceaccount istio-ingressgateway-service-account --namespace istio-system\n</code></pre></div>\n<p>I re-ran the install command just to make sure everything completes</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">istioctl install --set profile=ambient --set \"components.ingressGateways[0].enabled=true\" --set \"components.ingressGateways[0].name=istio-ingressgateway\" --skip-confirmation</code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ab7ae02fe0ce7c887eae1f6d3980e069/764d0/ambient.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 8%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAW0lEQVR42m2NwQ6AMAhDi8uAbic/wKv//4cVnRcTDy8F2hSgH4KfQuzqbMpIjUGRQ8xNc0Bzom5QJuTeylv7A1+/lKQAC8G8hq3AL2ZWRaFIKurhjfvS3v2TvwBWACpH8ElOKAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"ambient\"\n        title=\"\"\n        src=\"/static/ab7ae02fe0ce7c887eae1f6d3980e069/5a190/ambient.png\"\n        srcset=\"/static/ab7ae02fe0ce7c887eae1f6d3980e069/772e8/ambient.png 200w,\n/static/ab7ae02fe0ce7c887eae1f6d3980e069/e17e5/ambient.png 400w,\n/static/ab7ae02fe0ce7c887eae1f6d3980e069/5a190/ambient.png 800w,\n/static/ab7ae02fe0ce7c887eae1f6d3980e069/c1b63/ambient.png 1200w,\n/static/ab7ae02fe0ce7c887eae1f6d3980e069/29007/ambient.png 1600w,\n/static/ab7ae02fe0ce7c887eae1f6d3980e069/764d0/ambient.png 1898w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Now that we have ambient mesh installed we need to install prometheus and kiali before we install istio sample apps.</p>\n<h2>Installing Prometheus and Kiali on OpenShift</h2>\n<p>I installed Prometheus operator from the operator hub and used the sample prometheus installation provided by istio referenced here in this <a href=\"https://istio.io/latest/docs/ops/integrations/prometheus/#installation\">doc</a></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.20/samples/addons/prometheus.yaml</code></pre></div>\n<p>After you run the above command you are going to see these errors below</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">pods \"prometheus-5d5d6d6fc-\" is forbidden: unable to validate against any security context constraint: [provider \"anyuid\": Forbidden: not usable by user or serviceaccount, provider restricted-v2: .spec.securityContext.fsGroup: Invalid value: []int64{65534}: 65534 is not an allowed group, provider restricted-v2: .containers[0].runAsUser: Invalid value: 65534: must be in the ranges: [1000680000, 1000689999], provider restricted-v2: .containers[1].runAsUser: Invalid value: 65534: must be in the ranges: [1000680000, 1000689999], provider \"restricted\": Forbidden: not usable by user or serviceaccount, provider \"nonroot-v2\": Forbidden: not usable by user or serviceaccount, provider \"nonroot\": Forbidden: not usable by user or serviceaccount, provider \"hostmount-anyuid\": Forbidden: not usable by user or serviceaccount, provider \"machine-api-termination-handler\": Forbidden: not usable by user or serviceaccount, provider \"hostnetwork-v2\": Forbidden: not usable by user or serviceaccount, provider \"hostnetwork\": Forbidden: not usable by user or serviceaccount, provider \"hostaccess\": Forbidden: not usable by user or serviceaccount, provider \"node-exporter\": Forbidden: not usable by user or serviceaccount, provider \"privileged\": Forbidden: not usable by user or serviceaccount]</code></pre></div>\n<p>We can grant additional SCC's to <code class=\"language-text\">promethues</code> service account by running commands below</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">oc adm policy add-scc-to-user anyuid --serviceaccount prometheus --namespace istio-system\noc adm policy add-scc-to-user restricted-v2 --serviceaccount prometheus --namespace istio-system\noc adm policy add-scc-to-user restricted --serviceaccount prometheus --namespace istio-system\noc adm policy add-scc-to-user nonroot-v2 --serviceaccount prometheus --namespace istio-system\noc adm policy add-scc-to-user nonroot --serviceaccount prometheus --namespace istio-system\noc adm policy add-scc-to-user hostmount-anyuid --serviceaccount prometheus --namespace istio-system\noc adm policy add-scc-to-user machine-api-termination-handler --serviceaccount prometheus --namespace istio-system\noc adm policy add-scc-to-user hostnetwork-v2 --serviceaccount prometheus --namespace istio-system\noc adm policy add-scc-to-user hostnetwork --serviceaccount prometheus --namespace istio-system\noc adm policy add-scc-to-user hostaccess --serviceaccount prometheus --namespace istio-system\noc adm policy add-scc-to-user node-exporter --serviceaccount prometheus --namespace istio-system\noc adm policy add-scc-to-user privileged --serviceaccount prometheus --namespace istio-system</code></pre></div>\n<p>Install Kiali Operator from the operator hub and create an instance of kiali.</p>\n<h2>Deploy Istio sample apps</h2>\n<p>Deploy istio sample apps following the instructions <a href=\"https://istio.io/latest/docs/ops/ambient/getting-started/#bookinfo\">here</a> in this getting started with Ambient Mesh article</p>\n<h2>Expose a route to istio ingress gateway</h2>\n<p>Follow steps below to expose a route to istio ingress gateway so we can test the sample bookinfo application.</p>\n<ul>\n<li>Login to OpenShift console and navigate to <code class=\"language-text\">Routes</code> under <code class=\"language-text\">Networking</code></li>\n<li>Select <code class=\"language-text\">istio-system</code> in <code class=\"language-text\">Project</code> drop down and click <code class=\"language-text\">Create Route</code></li>\n<li>Enter <code class=\"language-text\">istio-ingressgateway</code> for <code class=\"language-text\">Name</code></li>\n<li>Select <code class=\"language-text\">istio-ingressgateway</code> for <code class=\"language-text\">Service</code></li>\n<li>Select <code class=\"language-text\">80-8080</code> for <code class=\"language-text\">Target Port</code> and click on <code class=\"language-text\">Create</code>.</li>\n</ul>\n<p>See screen capture below\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/013fbbc117c48251a9febf724ef47198/95e59/createroute.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.50000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAAB1UlEQVR42pWSTU8aURSGJ9V2V3HBRqgiMlP5EoQBakyjMdG/1Z/QblyaLvoLmrioSRuXxsSgMmJQorGLNiYWlJE73Pm68/ZcSmwXttCbPLOYmTx5z32PokWj0DMZRF5EEQ6H8Sw0hbFQFGMTETx5PvVPxkMRPJ0kQr9R0rkCtFQWs3EVyewi3mx9xtvtJt5tN7C5c4HNT8TO5aNsfbnC+92vxNUDSiqTx5yaRGxOQ26xhOZ5A/II4dMzGDD6UQp6BVI6HVOxkC/i4NBAu+vi5rqNH/UG2ucX6LTuYXLAZD5MSzxKhwkwLqBkc0WkadRYXCOhjqPjGliPg3W7YHcdOMyC53rwRTAUQShSFk/MDxKWUKsZ8H0PnHO4rguHsG2b3vkIgmAoSqmy3E+ovkyjWFrC6SndIX3o9XrgJJIyIcRIsr5wZW0Dy69XoZeXsLq2DqN+BO5wWHe3sJpncBmDkCVRQikeRn/k+dQCjZxAllaoelzHPfdgmyaCrvmfHeOPtaFS8oUyqtVDWI4D6/s3OO3Wr78G44yUUKaTpczMqrSHOk4MA27rBjbdoUcSWYxEljJSQjlyQktihhKWK6/w4eMe9vdp90z2IHNkYsvqN28PivobPwHgLfx2s2754gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"createroute\"\n        title=\"\"\n        src=\"/static/013fbbc117c48251a9febf724ef47198/5a190/createroute.png\"\n        srcset=\"/static/013fbbc117c48251a9febf724ef47198/772e8/createroute.png 200w,\n/static/013fbbc117c48251a9febf724ef47198/e17e5/createroute.png 400w,\n/static/013fbbc117c48251a9febf724ef47198/5a190/createroute.png 800w,\n/static/013fbbc117c48251a9febf724ef47198/c1b63/createroute.png 1200w,\n/static/013fbbc117c48251a9febf724ef47198/95e59/createroute.png 1460w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Grab the route URL and access the product page from a browser</p>","frontmatter":{"title":"Installing Istio Ambient Mesh on OpenShift","date":"January 31, 2024","tags":["Crossplane","AWS","EKS","Tools","Kubernetes"],"author":"Ram Gopinathan"}}},"pageContext":{"slug":"/installing-istio-ambient-mesh-on-openshift/"}},"staticQueryHashes":["1611934721","2366241629"],"slicesMap":{}}